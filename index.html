
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Libre+Baskerville">
  <title>STADENS POESI - en vandring till åtta dikter av STIG SJÖDIN</title>

  <style>
    :root {
      --base-font-size: 16px;
      --font-family-sans: Arial, Helvetica, sans-serif;
      --font-family-serif: "Libre Baskerville", Georgia, serif;
    }
    html, body { height: 100%; margin: 0; font-family: var(--font-family-sans); font-size: var(--base-font-size); line-height: 1.5; color: #222; }
    h2 { font-size: clamp(1.25rem, 1.2vw + 0.8rem, 1.75rem); margin: 0.25rem 0 0.5rem 0; }
    p { font-size: 1rem; margin: 0.4rem 0; }
    #googleMap { height: 100%; width: 100%; }
    .gm-style-iw { max-width: min(420px, 80vw); }

    .poem { font-family: var(--font-family-serif); white-space: pre-wrap; margin-top: 0.5rem; }
    .poem-wrap { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
    .toggle-poem, .route-to { display: inline-block; margin-top: 0.5rem; color: #1565c0; text-decoration: none; font-weight: 600; }
    .toggle-poem:hover, .route-to:hover { text-decoration: underline; }

    .map-control {
      background: #fff; border: 1px solid #ccc; border-radius: 4px;
      padding: 6px 10px; font-size: 0.95rem; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: pointer; user-select: none;
    }
    .map-control:hover { background: #f7f7f7; }

    @media (prefers-color-scheme: dark) {
      html, body { color: #eee; background: #111; }
      .map-control { background: #222; color: #eee; border-color: #444; }
    }
  </style>
</head>
<body>
  <div id="googleMap"></div>
<script src="dikter.js"></script>
  <script>
    let map, infoWindow, bounds;
    let userPos = null, userMarker = null, accuracyCircle = null;
    let directionsService = null, directionsRenderer = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("googleMap"), {
        center: { lat: 60.6189135, lng: 16.7788006 },
        zoom: 15,
        clickableIcons: false,
        styles: [
          { featureType: "landscape.man_made", elementType: "geometry", stylers: [{ color: "#5D4037" }] },
          { featureType: "poi", elementType: "geometry", stylers: [{ color: "#5D4037" }] },
          { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#3E2723" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#a0c8f0" }] },
          { featureType: "park", elementType: "geometry", stylers: [{ color: "#c5e1a5" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
          { featureType: "poi.business", stylers: [{ visibility: "off" }] },
          { featureType: "road", elementType: "labels", stylers: [{ visibility: "on" }] },
          { featureType: "poi.place_of_worship", stylers: [{ visibility: "on" }] },
          { featureType: "poi.school", stylers: [{ visibility: "on" }] },
          { featureType: "poi.government", stylers: [{ visibility: "on" }] },
          { featureType: "poi.medical", stylers: [{ visibility: "on" }] },
          { featureType: "poi", elementType: "labels.text", stylers: [{ visibility: "on" }] }
        ]
      });

      infoWindow = new google.maps.InfoWindow();
      bounds = new google.maps.LatLngBounds();

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressMarkers: false,
        preserveViewport: false,
        polylineOptions: { strokeColor: "#1976d2", strokeWeight: 5, strokeOpacity: 0.85 }
      });

      
        
      markers.forEach(m => {
        const marker = new google.maps.Marker({
          map,
          position: { lat: m.lat, lng: m.lng },
          label: { text: String(m.number), color: "black", fontSize: "22px", fontWeight: "900", fontFamily: "Libre Baskerville" },
          icon: { path: google.maps.SymbolPath.CIRCLE, fillColor: "red", fillOpacity: 1, scale: 15, strokeColor: "black", strokeWeight: 0 },
          title: m.title
        });


        const content = `
          <div>
            <h2>${m.title}</h2>
            <p>${m.description}</p>
            <div class="poem-wrap">
              <div class="poem">${escapeHtml(m.poem)}</div>
            </div>
            #Läs dikten</a>
            <br/>
            #
              Vägbeskrivning (gång)
            </a>
          </div>
        `;

        marker.addListener("click", () => {
          infoWindow.setContent(content);
          infoWindow.open(map, marker);

          // Koppla handlers när InfoWindow-DOM är redo
          google.maps.event.addListenerOnce(infoWindow, "domready", () => {
            const iw = document.querySelector(".gm-style-iw");
            if (!iw) return;

            // Toggle "Läs/Dölj"
            const wrap = iw.querySelector(".poem-wrap");
            const toggle = iw.querySelector(".toggle-poem");
            if (wrap && toggle) {
              wrap.style.maxHeight = "0px";
              toggle.textContent = "Läs dikten";
              toggle.setAttribute("aria-expanded", "false");

              toggle.addEventListener("click", (e) => {
                e.preventDefault();
                const isOpen = wrap.style.maxHeight && wrap.style.maxHeight !== "0px";
                if (isOpen) {
                  wrap.style.maxHeight = "0px";
                  toggle.textContent = "Läs dikten";
                  toggle.setAttribute("aria-expanded", "false");
                } else {
                  wrap.style.maxHeight = wrap.scrollHeight + "px";
                  toggle.textContent = "Dölj dikten";
                  toggle.setAttribute("aria-expanded", "true");
                }
              });
            }

            // Vägbeskrivning (gång)
            const routeBtn = iw.querySelector(".route-to");
            if (routeBtn) {
              routeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const lat = parseFloat(routeBtn.dataset.lat);
                const lng = parseFloat(routeBtn.dataset.lng);
                routeToDestination({ lat, lng });
              });
            }
          });
        });

        bounds.extend(marker.getPosition());
      });

      // Auto-zoom till alla punkter
      map.fitBounds(bounds);
      google.maps.event.addListenerOnce(map, "bounds_changed", () => {
        const maxZoom = 17;
        if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
      });

      // Geolokalisering + kontroll
      enableGeolocation();
      addClearRouteControl();
    }

    // --- Hjälpfunktioner ---
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function enableGeolocation() {
      if (!navigator.geolocation) {
        console.warn("Geolokalisering stöds inte i denna webbläsare.");
        return;
      }
      // initial
      navigator.geolocation.getCurrentPosition(
        setUserPosition,
        err => console.warn("Kunde inte hämta position:", err.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
      // live-uppdatering
      navigator.geolocation.watchPosition(
        pos => setUserPosition(pos, true),
        err => console.warn("WatchPosition-fel:", err.message),
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 5000 }
      );
    }

    function setUserPosition(pos, isUpdate = false) {
      const { latitude, longitude, accuracy } = pos.coords;
      userPos = { lat: latitude, lng: longitude };

      if (!userMarker) {
        userMarker = new google.maps.Marker({
          map,
          position: userPos,
          title: "Din position",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: "#1a73e8",
            fillOpacity: 1,
            scale: 8,
            strokeColor: "white",
            strokeWeight: 2
          },
          zIndex: 999
        });

        accuracyCircle = new google.maps.Circle({
          map,
          center: userPos,
          radius: Math.max(accuracy || 30, 10),
          strokeColor: "#1a73e8",
          strokeOpacity: 0.8,
          strokeWeight: 1,
          fillColor: "#1a73e8",
          fillOpacity: 0.15,
          zIndex: 998
        });

        bounds.extend(userMarker.getPosition());
        map.fitBounds(bounds);
        if (map.getZoom() > 17) map.setZoom(17);
      } else {
        userMarker.setPosition(userPos);
        accuracyCircle.setCenter(userPos);
        accuracyCircle.setRadius(Math.max(accuracy || 30, 10));
      }
    }

    function routeToDestination(dest) {
      if (!userPos) {
        alert("Din position är inte tillgänglig ännu. Tillåt platsåtkomst och försök igen.");
        return;
      }
      const req = {
        origin: new google.maps.LatLng(userPos.lat, userPos.lng),
        destination: new google.maps.LatLng(dest.lat, dest.lng),
        travelMode: google.maps.TravelMode.WALKING,
        provideRouteAlternatives: false
      };
      directionsService.route(req, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setMap(map);
          directionsRenderer.setDirections(result);
        } else {
          console.warn("Directions misslyckades:", status);
          const url = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${dest.lat},${dest.lng}&travelmode=walking`;
          window.open(url, "_blank");
        }
      });
    }

    function addClearRouteControl() {
      const ctrl = document.createElement("div");
      ctrl.className = "map-control";
      ctrl.textContent = "Rensa vägbeskrivning";
      ctrl.title = "Ta bort ritad gångväg";
      ctrl.addEventListener("click", () => {
        directionsRenderer.setMap(null);
        directionsRenderer = new google.maps.DirectionsRenderer({
          map,
          suppressMarkers: false,
          preserveViewport: false,
          polylineOptions: { strokeColor: "#1976d2", strokeWeight: 5, strokeOpacity: 0.85 }
        });
      });
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(ctrl);
    }


    // Ladda Maps API
    window.onload = function() {
      const script = document.createElement('script');
      script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDg3KLnpRbEjHD0Da-SidW12jU-Btr7fqM&language=sv&region=SE";
      script.async = true;
      script.defer = true;
      script.onload = initMap;
      document.head.appendChild(script);
    };
  </script>
</body>
</html>
